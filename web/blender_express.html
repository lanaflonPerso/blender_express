<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Blender Express</title>
<script src="common/b4w.min.js"></script>
<script>

var m = {
  app: b4w.require("app"),
  data: b4w.require("data"),
  scenes: b4w.require("scenes"),
  anim: b4w.require("animation"),
  sfx: b4w.require("sfx"),
  time: b4w.require("time"),
  ctl: b4w.require("controls"),
}

var Accelerator = function(train) {
  this.animation_id
  
  this.accelerate_to = function(speed, period) {
    if (train.speed != speed) {
      if (this.animation_id) {
        m.time.clear_animation(this.animation_id);
        this.animation_id = undefined;
      }
      if (! period) {
        period = Math.abs(train.speed - speed) * 500;
      }
      this.animation_id = m.time.animate(train.speed, speed, period, function(value){train.set_speed(value);});
    }
  }
}

function onFollowRailwayFinish(obj, slot){
  if(slot == m.anim.SLOT_0) {
    var anim_name = m.anim.get_current_anim_name(obj, slot);
    if (anim_name.startsWith("train.follow.railway.section.")) {
      var section = parseInt(anim_name.slice(29));
      section = (section % 2) + 1
      m.anim.apply(obj, "train.follow.railway.section." + section, slot);

      var speed = m.anim.get_speed(obj, m.anim.SLOT_1);
      m.anim.set_speed(obj, speed, slot);
      if (speed < 0) {
        m.anim.set_last_frame(obj, slot);
      }
      m.anim.play(obj, onFollowRailwayFinish, slot);
    }
  }
}

var Train = function() {
  this.armature = m.scenes.get_object_by_name("train.armature");
  this.loco_obj = m.scenes.get_object_by_name("train.loco")
  this.wheel_speaker = m.scenes.get_object_by_name("train.wheel.speaker");
  this.horn_speaker = m.scenes.get_object_by_name("train.horn.speaker");
  this.accelerator = new Accelerator(this);
  this.speed = 0;
  this.stop_at_station = false;
  
  m.anim.apply(this.armature, "train.follow.railway.section.2", m.anim.SLOT_0);
  m.anim.apply(this.armature, "train.move.forward", m.anim.SLOT_1);
  m.anim.set_behavior(this.armature, m.anim.AB_CYCLIC, m.anim.SLOT_1);
  
  var station_collision_sensor = m.ctl.create_collision_sensor(this.loco_obj, "STATION");
  m.ctl.create_sensor_manifold(this.loco_obj, "NEAR_STATION", m.ctl.CT_SHOT, [station_collision_sensor], function(s){return s[0]}, function(obj, id, pulse, train){train.enter_station();}, this);

    
  this.blow_horn = function() {
    if (!m.sfx.is_playing(this.horn_speaker)) {
      m.sfx.play(this.horn_speaker);
    }
  }
  
  this.accelerate_to = function(speed, period) {
    this.accelerator.accelerate_to(speed, period);
  }
  
  this.enter_station = function() {
    if(this.stop_at_station) {
      this.blow_horn();
      this.accelerator.accelerate_to(0, 500);
    }
  }
  
  this.set_speed = function(speed) {
    this.speed = speed;
    if (this.speed == 0) {
      if (m.anim.is_play(this.armature)) {
        m.anim.stop(this.armature, m.anim.SLOT_ALL);
        m.sfx.mute(this.wheel_speaker, true);
      }
    } else {
      m.anim.set_speed(this.armature, this.speed, m.anim.SLOT_ALL);
      m.sfx.playrate(this.wheel_speaker, Math.max(.8, 1 + Math.log(Math.abs(this.speed))))
      if (!m.anim.is_play(this.armature)) {
        m.anim.play(this.armature, onFollowRailwayFinish, m.anim.SLOT_ALL);
        m.sfx.mute(this.wheel_speaker, false);
      }
    }
  }
}

var train;

function init_scene() {
  train = new Train();
  document.getElementById("controlPanel").style.display = "block";
  toggle_movement();
}

function toggle_movement() {
  var speed_range = document.getElementById("speedRange");
  var speed = speed_range.value != 0  ? 0 : 1;
  speed_range.value = speed * 10;
  train.accelerate_to(speed);
}

m.app.init({
  canvas_container_id: "viewer",
  force_container_ratio: 1.66,
  callback: function() {
      m.data.load("scene/blender_express.json", function() {
        m.app.enable_controls();
        m.app.enable_camera_controls();
        init_scene();
    })
  }
})

</script>
</head>

<body>
  <div id="viewer" style="width: 1024px; height: 750px;"></div>
  <fieldset id="controlPanel" style="width: 800px; display:none">
    <legend>Blender Express</legend>
    <button onclick="train.blow_horn();">blow horn</button>
    <button onclick="toggle_movement()">start/stop</button>
    <input id="speedRange" type="range" min="-50" max="50" value="0" onchange="train.accelerate_to(this.value/10)" />
    <input type="checkbox" onchange="train.stop_at_station=this.checked">stop at station</input>
  </fieldset>
</body>
